<html>
  <head>
    <title>Observ Web Interface</title>
    <link rel="shortcut icon" href="../../media/observ_logo_icon.png" />
  </head>

  <body onload="setup(); update()">
  </body>
  <script>
    canvases = []
    timeout = 0

    window.onresize = function resize()
    {
      for (canvas in canvases)
      {
        e.setAttribute("width", e.calc_width());
        e.setAttribute("height", e.calc_height());

        e.style.left = e.abs_pos().x * window.innerWidth;
        e.style.top = e.abs_pos().y * window.innerHeight;
      }
    }

    function setup()
    {
      request = new XMLHttpRequest();
      request.onreadystatechange = function ()
      {
          if (this.readyState == 4 && this.status == 200)
          {
            if (this.getResponseHeader("Content-Type") == "application/json")
            {
              create_layout(JSON.parse(this.responseText));
            }
          }
      }
      request.open("POST", "", true);
      request.setRequestHeader('Content-Type', 'application/json');
      request.send(JSON.stringify(
        {
          action: "setup"
        }
      ));
    }

    function create_layout(layout)
    {
      for (canvas in layout)
      {
        e = document.createElement("canvas");

        e.origin = layout[canvas]["origin"];
        e.offset = layout[canvas]["offset"];
        e.tile_type = canvas.tile_type;
        e.calc_width = function ()
        {
          return (parseFloat(e.offset["x"]) - parseFloat(e.origin["x"])) * window.innerWidth;
        }
        e.calc_height = function ()
        {
          return (parseFloat(e.offset["y"]) - parseFloat(e.origin["y"])) * window.innerHeight;
        }
        e.abs_pos = function ()
        {
          return { x : parseFloat(e.origin["x"]), y : parseFloat(e.origin["y"])};
        }

        e.setAttribute("id", canvas);
        e.setAttribute("width", e.calc_width());
        e.setAttribute("height", e.calc_height());

        e.style.position = 'absolute';
        e.style.left = e.abs_pos().x * window.innerWidth;
        e.style.top = e.abs_pos().y * window.innerHeight;

        canvases.push(e);
        document.body.appendChild(e);
      }
    }
  
    function update()
    {
      request = new XMLHttpRequest();
      request.onreadystatechange = function ()
      {
        if (this.readyState == 4 && this.status == 200)
        {
          if (this.getResponseHeader("Content-Type") == "application/json")
          {
            update_tiles(JSON.parse(this.responseText));
          }
        }
      }
      request.open("POST", "", true);
      request.setRequestHeader('Content-Type', 'application/json');

      while (1)
      {
        setTimeout(request_update, timeout, request);
      }
    }

    function request_update(request)
    {
      request.send(JSON.stringify(
        {
          action: "update"
        }
      ));
    }

    function update_tiles(tiles)
    {
      for (id in tiles)
      {
        console.log(id, tiles[id])
      }
    }

  </script>
</html>